# Rabbitmq

Rabbitmqæœ¬èº«æ˜¯ç»™äºˆ Erlangç¼–å†™çš„ï¼ŒErlang è¯­è¨€å¤©ç”Ÿå°±å…·æœ‰åˆ†å¸ƒå¼çš„ç‰¹æ€§ï¼ˆ.erlange.cookieå®ç°é›†ç¾¤å¹¶ä¸”é›†ç¾¤èŠ‚ç‚¹çš„é€šä¿¡ï¼‰


# RabbitMQé›†ç¾¤å’Œé«˜å¯ç”¨æ–¹æ¡ˆ
- æ™®é€šé›†ç¾¤æ¨¡å¼
- é•œåƒå¤åˆ¶æ¨¡å¼

## æ™®é€šé›†ç¾¤æ¨¡å¼
æ¯å°æœºå™¨ä¸­éƒ¨ç½²ä¸€ä¸ªRabbitMQæœåŠ¡èŠ‚ç‚¹ï¼Œè¿›è€Œç”±å¤šä¸ªæœºå™¨ç»„æˆä¸€ä¸ªRabbitMQé›†ç¾¤
æ™®é€šæ¨¡å¼ä¸­ï¼Œæ¶ˆæ¯æ•°æ®æ˜¯ä¸ä¼šåŒæ­¥çš„ï¼Œå› ä¸ºå®ƒä»¬ä¹‹é—´åªåŒæ­¥ å…ƒæ•°æ®ï¼Œå…ƒæ•°æ®ä¸­ä¸åŒ…å«æ¶ˆæ¯æ•°æ®ã€‚
è‹¥ å®¢æˆ·ç«¯è¿æ¥åˆ° AèŠ‚ç‚¹ï¼Œä½†æ˜¯æ¶ˆæ¯åˆåœ¨ BèŠ‚ç‚¹ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ™®é€šé›†ç¾¤æ¨¡å¼æ— æ³•å®ç°æ¶ˆæ¯åœ¨èŠ‚ç‚¹ä¸­çš„è½¬å‘ï¼Œ
æ‰€ä»¥æ™®é€šé›†ç¾¤æ¨¡å¼æ— æ³•å®ç°é«˜å¯ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨é•œåƒå¤åˆ¶æ¨¡å¼å®ç°è¿™ç§éœ€æ±‚ã€‚

æµç¨‹å›¾
![img.png](images/æ™®é€šé›†ç¾¤æ¨¡å¼.png)

å…ƒæ•°æ®åŒ…å«ï¼šï¼ˆä¸åŒ…å«æ¶ˆæ¯ï¼‰
é˜Ÿåˆ—å…ƒæ•°æ®ï¼š é˜Ÿåˆ—åç§°ã€å±æ€§ç­‰
äº¤æ¢å™¨æ•°æ®ï¼š äº¤æ¢å™¨åç§°ã€å±æ€§
ç»‘å®šå…ƒæ•°æ®ï¼š äº¤æ¢å™¨ç»‘å®šé˜Ÿåˆ—æ•°æ®ã€äº¤æ¢å™¨å’Œäº¤æ¢å™¨ç»‘å®šæ•°æ®
vhostå…ƒæ•°æ®ï¼š vhostå†…çš„é˜Ÿåˆ—ã€å’Œäº¤æ¢å™¨ç»‘å®šçš„æ•°æ®ã€å‘½åç©ºé—´ã€å®‰å…¨å±æ€§ä¹‹é—´çš„ç»‘å®šå…³ç³»æ•°æ®

## é•œåƒå¤åˆ¶æ¨¡å¼
é•œåƒå¤åˆ¶æ¨¡å¼æ˜¯åœ¨æ™®é€šé›†ç¾¤æ¨¡å¼åŸºç¡€ä¸Šï¼Œé€šè¿‡ policy æ¨¡å—æ¥å®ç°ï¼Œä½¿ç”¨é•œåƒå¤åˆ¶æ¨¡å¼å¯ä»¥å®ç°RabbitMQçš„é«˜å¯ç”¨æ–¹æ¡ˆ
æµç¨‹å›¾
![img.png](images/é•œåƒå¤åˆ¶æ¨¡å¼.png)

é•œåƒå¤åˆ¶æ¨¡å¼ç›¸æ¯”äºæ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œä¼šå ç”¨æ¯”è¾ƒå¤šçš„å¸¦å®½ï¼Œå› ä¸ºéœ€è¦å®ç°ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹çš„æ•°æ®å¤åˆ¶ï¼Œæ‰€ä»¥é•œåƒå¤åˆ¶æ¨¡å¼ååé‡ä¼šç¨é€Šæ™®é€šæ¨¡å¼ï¼Œ
ä½†æ˜¯æ™®é€šæ¨¡å¼ä¸èƒ½å®ç°é«˜å¯ç”¨ï¼ŒæŸä¸ªèŠ‚ç‚¹æŒ‚æ‰ä¹‹ååï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ¶ˆæ¯æ— æ³•è¢«æ¶ˆè´¹ï¼Œéœ€è¦ç­‰å¾…èŠ‚ç‚¹å¯åŠ¨åæ‰èƒ½è¢«æ¶ˆè´¹


## èŠ‚ç‚¹ç±»å‹
ramï¼šå†…å­˜èŠ‚ç‚¹ å…ƒæ•°æ®å­˜åœ¨å†…å­˜ä¸­ã€‚å¦‚æœæ¶ˆæ¯æŒä¹…åŒ–ä¼šå­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼Œå› ä¸ºå†…å­˜èŠ‚ç‚¹çš„è¯»å–é€Ÿåº¦å—ï¼Œä¸€èˆ¬å®¢æˆ·ç«¯ä¼šè¿æ¥å†…å­˜èŠ‚ç‚¹
discï¼šç£ç›˜èŠ‚ç‚¹ é»˜è®¤èŠ‚ç‚¹ç±»å‹ï¼Œéœ€è¦ä¿è¯è‡³å°‘ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œå¦åˆ™ä¸€æ—¦å®•æœºï¼Œåˆ™æ— æ³•æ¢å¤æ•°æ®ï¼Œä»è€Œæ— æ³•è¾¾åˆ°é«˜å¯ç”¨ï¼ 


## æ™®é€šé›†ç¾¤æ¨¡å¼æ­å»ºæ­¥éª¤

-  3å°centos7æœåŠ¡å™¨ï¼š
````
192.168.2.9
192.168.2.11
192.168.2.7
````

-  ä¿®æ”¹hostæ–‡ä»¶
````
192.168.2.9 rabbit_host11
192.168.2.11 rabbit_host22
192.168.2.7 rabbit_host33
````
- æˆ–è€…å•ç‹¬è®¾ç½®æ¯å°æœºå™¨çš„ï¼š
````
hostnamectl set-hostname rabbit_host11
hostnamectl set-hostname rabbit_host22
hostnamectl set-hostname rabbit_host33
````

- docker-compose å®‰è£…rabbitmqï¼Œå‚è€ƒ yml é…ç½®æ–‡ä»¶ã€‚å…ˆåå¯åŠ¨ rabbitmq1 ã€ rabbitmq2 ã€ rabbitmq3
````
services:
  rabbitmq1:
    image: rabbitmq:3.8.9-management
    container_name: rabbitmq1
    hostname: rabbit_host1
    ports:
      - "4369:4369"
      - "5671:5671"
      - "5672:5672"
      - "15671:15671"
      - "15672:15672"
      - "25672:25672"
    extra_hosts:
      - "rabbit_host1:192.168.2.9"
      - "rabbit_host2:192.168.2.11"
      - "rabbit_host3:192.168.2.7"
    volumes:
      - /root/mqz/rabbitmq/docker/lib:/var/lib/rabbitmq
      - /root/mqz/rabbitmq/docker/log:/var/log/rabbitmq
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=mqz
      - RABBITMQ_DEFAULT_PASS=mqz
      - RABBITMQ_NODENAME:rabbitmq1

````
- ç»Ÿä¸€ä¸‰ä¸ªrabbitmqçš„ /var/lib/rabbitmq/.erlang.cookie ï¼ˆä¹Ÿå¯èƒ½æ˜¯åœ¨ $HOME/.erlang.cookie ç›®å½•ï¼‰ æ–‡ä»¶ï¼Œæ³¨æ„å®ƒæ˜¯ä¸€ä¸ªéšè—æ–‡ä»¶ï¼Œå°±åƒæˆ‘ç”µè„‘é‡Œåˆéšè—çš„ .avi æ–‡ä»¶ä¸€æ ·ğŸ¶
  RabbitMQ çš„é›†ç¾¤æ˜¯ä¾èµ– erlang é›†ç¾¤ï¼Œè€Œ erlang é›†ç¾¤æ˜¯é€šè¿‡è¿™ä¸ª cookie è¿›è¡Œé€šä¿¡è®¤è¯
  å°†rabbitmq2 ã€ rabbitmq3 çš„ .erlang.cookieæ–‡ä»¶å†…å®¹ä»¥ rabbitmq1çš„ä¸ºä¸»ï¼Œæ‹·è´æ—¶éœ€è¦åœæ­¢rabbitmqå®ä¾‹
  æ³¨æ„æƒé™ ï¼š chmod 600 /var/lib/rabbitmq/.erlang.cookie ï¼Œå¦åˆ™åŠ å…¥é›†ç¾¤ä¼šæŠ¥é”™
  ![img.png](images/erlang.cookieæ–‡ä»¶æƒé™.png)
  éšåé‡å¯rabbitmqï¼š docker restart rabbitmq1 \ rabbitmq2 \ rabbitmq3


- ä¸»èŠ‚ç‚¹æ‰§è¡Œï¼šéœ€è¦æ¸…ç©ºä¹‹å‰å•æœºä¿¡æ¯ï¼Œdockeråˆ™æ¸…ç©ºæŒ‚è½½çš„é…ç½®æ–‡ä»¶
````
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
````
- ä»èŠ‚ç‚¹ï¼š æ‰§è¡Œå‰éœ€è¦åœæ­¢è¯¥ rabbitmq å³ rabbitmqctl stop_app
````
rabbitmqctl [-n nodename] join_cluster {cluster_node} [â€”ram]
rabbitmqctl stop_app
rabbitmqctl reset å¦‚æœèŠ‚ç‚¹ç±»å‹ä¸º discçš„æ—¶å€™éœ€è¦æ‰§è¡Œ
rabbitmqctl join_cluster --ram rabbit@rabbit_host11 æˆ–è€… rabbitmqctl join_cluster --disc rabbit@rabbit_host11
rabbitmqctl start_app


å¦‚æœèŠ‚ç‚¹ä»¥ç£ç›˜èŠ‚ç‚¹çš„å½¢å¼åŠ å…¥ï¼Œåˆ™éœ€è¦å…ˆä½¿ç”¨ rabbitmqctl reset å‘½ä»¤è¿›è¡Œé‡ç½®ï¼Œç„¶åæ‰èƒ½åŠ å…¥ç°æœ‰ç¾¤é›†ï¼Œé‡ç½®èŠ‚ç‚¹ä¼šåˆ é™¤è¯¥èŠ‚ç‚¹ä¸Šå­˜åœ¨çš„æ‰€æœ‰çš„å†å²èµ„æºå’Œæ•°æ®ã€‚
é‡‡ç”¨å†…å­˜èŠ‚ç‚¹çš„å½¢å¼åŠ å…¥æ—¶å¯ä»¥ç•¥è¿‡ reset è¿™ä¸€æ­¥ï¼Œå› ä¸ºå†…å­˜ä¸Šçš„æ•°æ®æœ¬èº«å°±ä¸æ˜¯æŒä¹…åŒ–çš„
--ram è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå†…å­˜èŠ‚ç‚¹: æ‰€æœ‰æ•°æ®éƒ½å­˜åœ¨å†…å­˜ä¸­
--discè¡¨ç¤ºç£ç›˜èŠ‚ç‚¹ï¼ˆé»˜è®¤ä¹Ÿæ˜¯ç£ç›˜èŠ‚ç‚¹ï¼‰ï¼šæ‰€æœ‰æ•°æ®éƒ½å­˜åœ¨ç£ç›˜ä¸­
-n nodenameï¼š æŒ‡å®šéœ€è¦æ“ä½œçš„ç›®æ ‡èŠ‚ç‚¹
cluster_nodeï¼šéœ€è¦åŠ å…¥çš„é›†ç¾¤èŠ‚ç‚¹å
````



![img.png](images/rabbitmqç®¡ç†ç•Œé¢.png)



## ä¸»èŠ‚ç‚¹æ‰§è¡Œ - æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€
rabbitmqctl status
````

Status of node rabbit@rabbit_host11 ...
Runtime

OS PID: 19
OS: Linux
Uptime (seconds): 3319
Is under maintenance?: false
RabbitMQ version: 3.10.1
Node name: rabbit@rabbit_host11
Erlang configuration: Erlang/OTP 24 [erts-12.3.2] [source] [64-bit] [smp:2:2] [ds:2:2:10] [async-threads:1] [jit]
Erlang processes: 444 used, 1048576 limit
Scheduler run queue: 1
Cluster heartbeat timeout (net_ticktime): 60

Plugins

Enabled plugin file: /etc/rabbitmq/enabled_plugins
Enabled plugins:

 * rabbitmq_delayed_message_exchange
 * rabbitmq_prometheus
 * prometheus
 * accept
 * rabbitmq_management
 * amqp_client
 * rabbitmq_web_dispatch
 * cowboy
 * cowlib
 * rabbitmq_management_agent

Data directory

Node data directory: /var/lib/rabbitmq/mnesia/rabbit@rabbit_host11
Raft data directory: /var/lib/rabbitmq/mnesia/rabbit@rabbit_host11/quorum/rabbit@rabbit_host11

Config files

 * /etc/rabbitmq/conf.d/10-defaults.conf

Log file(s)

 * /var/log/rabbitmq/rabbit@rabbit_host11_upgrade.log
 * <stdout>

Alarms

(none)

Memory

Total memory used: 0.1404 gb
Calculation strategy: rss
Memory high watermark setting: 0.4 of available memory, computed to: 3.2409 gb

reserved_unallocated: 0.0678 gb (48.27 %)
code: 0.0357 gb (25.39 %)
other_system: 0.0252 gb (17.93 %)
other_proc: 0.0189 gb (13.43 %)
other_ets: 0.0033 gb (2.37 %)
plugins: 0.0032 gb (2.28 %)
atom: 0.0014 gb (1.02 %)
mgmt_db: 0.0011 gb (0.8 %)
binary: 9.0e-4 gb (0.64 %)
connection_other: 4.0e-4 gb (0.25 %)
metrics: 3.0e-4 gb (0.19 %)
queue_procs: 2.0e-4 gb (0.11 %)
mnesia: 1.0e-4 gb (0.1 %)
connection_readers: 1.0e-4 gb (0.07 %)
msg_index: 0.0 gb (0.02 %)
connection_channels: 0.0 gb (0.02 %)
quorum_ets: 0.0 gb (0.02 %)
connection_writers: 0.0 gb (0.01 %)
quorum_queue_dlx_procs: 0.0 gb (0.0 %)
stream_queue_procs: 0.0 gb (0.0 %)
stream_queue_replica_reader_procs: 0.0 gb (0.0 %)
allocated_unused: 0.0 gb (0.0 %)
queue_slave_procs: 0.0 gb (0.0 %)
quorum_queue_procs: 0.0 gb (0.0 %)
stream_queue_coordinator_procs: 0.0 gb (0.0 %)

File Descriptors

Total: 5, limit: 1048479
Sockets: 2, limit: 943629

Free Disk Space

Low free disk space watermark: 0.05 gb
Free disk space: 5.5612 gb

Totals

Connection count: 2
Queue count: 6
Virtual host count: 1

Listeners

Interface: [::], port: 15672, protocol: http, purpose: HTTP API
Interface: [::], port: 15692, protocol: http/prometheus, purpose: Prometheus exporter API over HTTP
Interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

````

## ä¸»èŠ‚ç‚¹æ‰§è¡Œ - æŸ¥çœ‹é›†ç¾¤çŠ¶æ€


rabbitmqctl cluster_status
````
root@rabbit_host11:/# rabbitmqctl cluster_status
Cluster status of node rabbit@rabbit_host11 ...
Basics

Cluster name: rabbit@rabbit_host11

Disk Nodes

rabbit@rabbit_host11
rabbit@rabbit_host22

Running Nodes

rabbit@rabbit_host11
rabbit@rabbit_host22

Versions

rabbit@rabbit_host11: RabbitMQ 3.10.1 on Erlang 24.3.4
rabbit@rabbit_host22: RabbitMQ 3.10.1 on Erlang 24.3.4

Maintenance status

Node: rabbit@rabbit_host11, status: not under maintenance
Node: rabbit@rabbit_host22, status: not under maintenance

Alarms

(none)

Network Partitions

(none)

Listeners

Node: rabbit@rabbit_host11, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@rabbit_host11, interface: [::], port: 15692, protocol: http/prometheus, purpose: Prometheus exporter API over HTTP
Node: rabbit@rabbit_host11, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@rabbit_host11, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0
Node: rabbit@rabbit_host22, interface: [::], port: 15672, protocol: http, purpose: HTTP API
Node: rabbit@rabbit_host22, interface: [::], port: 15692, protocol: http/prometheus, purpose: Prometheus exporter API over HTTP
Node: rabbit@rabbit_host22, interface: [::], port: 25672, protocol: clustering, purpose: inter-node and CLI tool communication
Node: rabbit@rabbit_host22, interface: [::], port: 5672, protocol: amqp, purpose: AMQP 0-9-1 and AMQP 1.0

Feature flags

Flag: classic_mirrored_queue_version, state: enabled
Flag: drop_unroutable_metric, state: enabled
Flag: empty_basic_get_metric, state: enabled
Flag: implicit_default_bindings, state: enabled
Flag: maintenance_mode_status, state: enabled
Flag: quorum_queue, state: enabled
Flag: stream_queue, state: enabled
Flag: user_limits, state: enabled
Flag: virtual_host_metadata, state: enabled
````
![æŸ¥çœ‹å·²å®‰è£…çš„æ’ä»¶.png](images/æŸ¥çœ‹å·²å®‰è£…çš„æ’ä»¶.png)



## é•œåƒå¤åˆ¶æ¨¡å¼-é«˜å¯ç”¨æ¨¡å¼
- é•œåƒé˜Ÿåˆ—æ¨¡å¼ç›¸æ¯”è¾ƒæ™®é€šæ¨¡å¼ï¼Œé•œåƒæ¨¡å¼ä¼šå ç”¨æ›´å¤šçš„å¸¦å®½æ¥è¿›è¡ŒåŒæ­¥ï¼Œæ‰€ä»¥é•œåƒé˜Ÿåˆ—çš„ååé‡ä¼šä½äºæ™®é€šæ¨¡å¼ã€‚
  ä½†æ™®é€šæ¨¡å¼ä¸èƒ½å®ç°é«˜å¯ç”¨ï¼ŒæŸä¸ªèŠ‚ç‚¹æŒ‚äº†åï¼Œè¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„æ¶ˆæ¯å°†æ— æ³•è¢«æ¶ˆè´¹ï¼Œéœ€è¦ç­‰å¾…èŠ‚ç‚¹å¯åŠ¨åæ‰èƒ½è¢«æ¶ˆè´¹ã€‚
- éœ€è¦ä½¿ç”¨ policy æ¨¡å—ï¼Œpolicyä¸»è¦ç”¨äºè®¾ç½® Exchange æˆ–è€… Queue çš„æ•°æ®éœ€è¦å¦‚ä½•å¤åˆ¶ï¼ŒåŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹
- è®¾ç½®ä¸»èŠ‚ç‚¹åŒæ­¥ä»èŠ‚ç‚¹ äº¤æ¢æœºã€é˜Ÿåˆ—çš„ç­–ç•¥è§„åˆ™
 1.å‘½ä»¤ï¼š rabbitmqctl set_policy -p / ha "^" '{"ha-mode":"all"}'  
         rabbitmqctl -n rabbit1 set_policy ha-all "^" '{"ha-mode":"all"}'
````    
ha ï¼š ç­–ç•¥åç§°
^  ï¼š åŒ¹é…è§„åˆ™ï¼Œ ^ åˆ™è¡¨ç¤ºåŒ¹é…æ‰€æœ‰ ^Q åˆ™åŒ¹é…åå­—
{"ha-mode":"exactly","ha-params":2} ï¼š æ˜¯ç­–ç•¥çš„å®šä¹‰ï¼Œ ha-modeå’Œha-paramsç»„åˆä½¿ç”¨

            ha-mode   ha-params   è¯´æ˜ 
             all      ï¼ˆemptyï¼‰   é˜Ÿåˆ—é•œåƒåˆ°é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹
             exactly   intå€¼      é˜Ÿåˆ—é•œåƒåˆ°é›†ç¾¤å†…æŒ‡å®šæ•°é‡èŠ‚ç‚¹ï¼Œè‹¥é›†ç¾¤å†…èŠ‚ç‚¹æ•°å°‘äºè¯¥å€¼ï¼Œé˜Ÿåˆ—å°†ä¼šé•œåƒåˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼Œè‹¥å¤§äºè¯¥å€¼ï¼Œè€Œä¸”ä¸€ä¸ªåŒ…å«é•œåƒçš„èŠ‚ç‚¹åœæ­¢ï¼Œåˆ™æ–°çš„é•œåƒä¸ä¼šåœ¨å…¶ä»–èŠ‚ç‚¹åˆ›å»º
             nodes     èŠ‚ç‚¹åç§°    é˜Ÿåˆ—é•œåƒåˆ°æŒ‡å®šèŠ‚ç‚¹ï¼ŒæŒ‡å®šèŠ‚ç‚¹ä¸åœ¨é›†ç¾¤ä¸­ä¸ä¼šæŠ¥é”™ï¼Œå½“é˜Ÿåˆ—ç”³æ˜æ—¶å€™ï¼Œå¦‚æœæŒ‡å®šèŠ‚ç‚¹ä¸åœ¨çº¿ï¼Œåˆ™é˜Ÿåˆ—ä¼šè¢«åˆ›å»ºåœ¨å®¢æˆ·ç«¯è¿æ¥çš„èŠ‚ç‚¹ä¸Š
````
- è®¾ç½®ç­–ç•¥åŒ¹é…æ‰€æœ‰åç§°æ˜¯ampå¼€å¤´çš„é˜Ÿåˆ—éƒ½å­˜å‚¨åœ¨2ä¸ªèŠ‚ç‚¹ä¸Šçš„å‘½ä»¤å¦‚ä¸‹
````  
  rabbitmqctl set_policy -p / ha "^amp*" '{"ha-mode":"exactly","ha-params":2}'
````  
- è®¾ç½®ç­–ç•¥åŒ¹é…æ‰€æœ‰åç§°çš„é˜Ÿåˆ—éƒ½è¿›è¡Œé«˜å¯ç”¨é…ç½®
````
  rabbitmqctl set_policy -p / ha "^" '{"ha-mode":"all","ha-sync-mode":"automatic"}'

````
- æŸ¥è¯¢ç­–ç•¥ #æŸ¥çœ‹vhostä¸‹çš„æ‰€æœ‰çš„ç­–ç•¥ï¼ˆpolicies ï¼‰
````
rabbitmqctl list_policies -p /
````


 2.webç®¡ç†ç•Œé¢æ–¹å¼ï¼š  
![img.png](images/é•œåƒå¤æ¨¡å¼é…ç½®policy.png)


## é›†ç¾¤çš„å…³é—­å’Œé‡å¯
æ— æ³•ä¸€æ¡å‘½ä»¤å…³é—­æˆ–é‡å¯é›†ç¾¤ï¼Œéœ€è¦ä¸€ä¸€è¿›è¡Œæ“ä½œï¼
å‡è®¾åœ¨ä¸€ä¸ªä¸‰èŠ‚ç‚¹çš„é›†ç¾¤å½“ä¸­ï¼Œå…³é—­çš„é¡ºåºä¸º node1ï¼Œnode2ï¼Œnode3ï¼Œå¦‚æœ node1 å› ä¸ºæ•…éšœæš‚æ—¶æ²¡æ³•æ¢å¤ï¼Œæ­¤æ—¶ node2 å’Œ node3 å°±æ— æ³•å¯åŠ¨ã€‚æƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å…ˆå°† node1 èŠ‚ç‚¹è¿›è¡Œå‰”é™¤ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š
rabbitmqctl forget_cluster_node rabbit@node1 --offline  # --offline ï¼š å…è®¸èŠ‚ç‚¹åœ¨è‡ªå·±æ²¡æœ‰å¯åŠ¨çš„æƒ…å†µä¸‹å¯ä»¥å°†å…¶ä»–èŠ‚ç‚¹åˆ é™¤

rabbitmqctl forget_cluster_node rabbit@node1 ï¼š å¼ºåˆ¶åˆ é™¤èŠ‚ç‚¹å‡ºé›†ç¾¤


- è§£é™¤é›†ç¾¤ ï¼ˆä¸»ã€ä»ï¼‰
  rabbitmqctl stop_app
  rabbitmqctl reset
  rabbitmqctl start_app

# åŸºäº HAProxy + Keepalived é«˜å¯ç”¨é›†ç¾¤






